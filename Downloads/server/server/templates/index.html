{% extends "base.html" %} {% block content %}

<div>
    <button id="start-camera">Start Camera</button>
    <video id="video" width="320" height="240" autoplay></video>
    <button id="start-record">Start Recording</button>
    <button id="stop-record">Stop Recording</button>
    <a id="download-video" download="test.webm">Download Video</a>
    <form method="POST" enctype="multipart/form-data">
        <input id="textinput" type="text" name="link">
        <input type="file" id="videofile" name="videofile">
        <input id="submitbtn" name='submit' type="submit"/>
    </form>
</div>
<script type="text/javascript">
    let camera_button = document.querySelector("#start-camera");
    let video = document.querySelector("#video");
    let start_button = document.querySelector("#start-record");
    let stop_button = document.querySelector("#stop-record");
    let download_link = document.querySelector("#download-video");
    let submit = document.querySelector("#submitbtn");
    let textinput = document.querySelector("#textinput");
    let videofile = document.querySelector("#videofile");

    let camera_stream = null;
    let media_recorder = null;
    let blobs_recorded = [];

    camera_button.addEventListener('click', async function() {
        camera_stream = await navigator.mediaDevices.getUserMedia({ video: true});
        video.srcObject = camera_stream;

    });

    start_button.addEventListener('click', function() {
        
        media_recorder = new MediaRecorder(camera_stream, { mimeType: 'video/webm' });

        media_recorder.addEventListener('dataavailable', function(e) {
            blobs_recorded.push(e.data);
        });

        media_recorder.addEventListener('stop', function() {
            let video_local = URL.createObjectURL(new Blob(blobs_recorded, { type: 'video/mp4' }));
            download_link.href = video_local;
            textinput.value = video_local;
            let finalblob = new Blob(blobs_recorded, { type: 'video/mp4' });
            let file = new File([finalblob], "vid.mp4",{ type: 'video/mp4' });
            let container = new DataTransfer();
            container.items.add(file);
            videofile.files = container.files;
            submit.click();
        });

        media_recorder.start(1000);
    });

    stop_button.addEventListener('click', function() {
        media_recorder.stop();
    });
</script>

{% endblock %}